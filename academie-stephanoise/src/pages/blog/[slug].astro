---
import Layout from "../../layouts/Layout.astro";
import BlogContent from "../../components/BlogContent.jsx"; // React component for Rich Text
import { contentfulClient } from "../../../contentful.js";

// Generate all possible paths for the blog posts
export async function getStaticPaths() {
  const entries = await contentfulClient.getEntries({
    content_type: "blogPost",
  });

  return entries.items.map((item) => ({
    params: { slug: item.fields.slug },
  }));
}

// Get the slug from URL params
const { slug } = Astro.params;

// Fetch the blog post data
const entry = await contentfulClient.getEntries({
  content_type: "blogPost",
  "fields.slug": slug,
  include: 1, // Include linked assets
});

if (!entry.items.length) {
  throw new Error(`No post found for slug: ${slug}`);
}

const post = entry.items[0].fields;
const image = entry.includes?.Asset?.find(
  (asset) => asset.sys.id === post.imagePresentation.sys.id
);

// Set SEO metadata
const title = `${post.titre} - Académie Stéphanoise`;
const description = post.contenus.content[0]?.content[0]?.value || post.titre;
const keywords = `${post.titre}, Académie Stéphanoise, articles`;
---

<Layout title={title} description={description} keywords={keywords}>
  <article class="max-w-4xl mx-auto p-4">
    <h1 class="text-3xl font-bold mb-4">{post.titre}</h1>
    {
      image && (
        <img
          src={image.fields.file.url}
          alt={post.titre}
          class="w-full h-auto mb-4 rounded-lg"
        />
      )
    }
    <p class="text-sm text-gray-500 mb-4">
      {post.auteur} - {new Date(post.datePublication).toLocaleDateString()}
    </p>

    <!-- Render the blog content using a React component -->
    <BlogContent content={post.contenus} />
  </article>
</Layout>
